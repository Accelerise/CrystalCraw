<!DOCTYPE html>
<html>
<head>
	<title>Crapy Web</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<script src="js/jquery-3.2.1.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/jquery.validate.min.js"></script>
	<style type="text/css">
	.alertHidden{
		display: none
	}
	.error{
		color: #FF6666
	}
	.loadingDiv{
		position: absolute;
		z-index: 100;
		width: 100%;
		height: 100%;
		left: -100%; 
		background-color: rgba(37, 37, 37, 0.6);
		transition: left 0.4s;
	}
	.loadinggif{
		position: absolute;
		width: 100%;
		background-color: rgb(37, 37, 37);
		top: 30%;
	}
	.loadingtext{
		color: rgb(12, 255, 255);
		font-size: 18px;
		text-align: center;
	}
	.btn-black{
		background-color: black;
		color: white;
		border-color:black;
	}
	</style>
</head>
<body>
	<div class="loadingDiv">
		<div class="loadinggif">
			<!-- 应当去掉此button -->
			<button class="btn btn-default btn-black btn-sm pull-right" id="colseBtn">Colse</button>
			<img src="./img/loading.gif" alt="loading_gif" class="center-block">
			<p></p>
			<p class="loadingtext">已经爬取了<span id="number">...</span>个网页</p>
			
		</div>
	</div>

	<header class="container">
		<div class="page-header">
			<h1>Welcome To Automatic crawler
				<small>Input the message in the form and submit</small>
			</h1>
		</div>
	</header>	

	<div class="container formDiv" >
		<form class="form-horizontal" role="form" id="mainForm">
			<div class="form-group">
				<label for="mainUrl" class=" col-sm-2 control-label"> THE MAIN URL</label>
				<div class="col-sm-8">
					<input type="url" name="mainUrl" id="mainUrl" class="form-control" placeholder="Please input the URL">				
				</div>
			</div>
			<div class="form-group ">
				<label for="dataUrl" class=" col-sm-2 control-label"> THE DATA URL</label>
				<div class="col-sm-8">
					<input type="url" name="dataUrl" id="dataUrl" class="form-control" placeholder="Please input the URL">				
				</div>
			</div>
			<div class="form-group ">
				<label for="attName0" class=" col-sm-2 control-label"> ATTRIBUTE1 NAME</label>
				<div class="col-sm-2">
					<input type="text" name="attName0" id="attName0" class="form-control" placeholder="Please input the attribute">				
				</div>
				<label for="Xpath0" class="col-sm-1 control-label"> XPath1 </label>
				<div class="col-sm-5">
					<input type="text" name="Xpath0" id="Xpath0" class="form-control" placeholder="Please input the XPath">				
				</div>
			</div>
			<div class="form-group " id = "Btn">
				<div class="col-sm-offset-2 col-sm-8">
					<button class="btn btn-default btn-md" id="addAttr" type="button">
						<span class="glyphicon glyphicon-plus"></span>
					</button>
					<button class="btn btn-default btn-md" id="cutAttr" type="button">
						<span class="glyphicon glyphicon-minus"></span>
					</button>
				</div>
					
			</div>
			
			<hr>
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-8">
					<button class="btn btn-default" type="submit" id="subBtn">SUBMIT</button>
				</div>
			</div>

			<div class="container">
				<div class="alert alert-success  alertHidden col-sm-10 ">
   					<button type="button" class="close">&times;</button>
   					SUBMIT SUCCESS!
  				</div>
  				<div class="alert alert-warning  alertHidden col-sm-10 ">
   					<button type="button" class="close">&times;</button>
   					LOADING!
  				</div>
  				<div class="alert alert-danger  alertHidden col-sm-10 ">
   					<button type="button" class="close">&times;</button>
   					ERROR!
  				</div>
			</div>

		</form>
		<button type="button" class="btn btn-default" id="testbtn">test</button>
	</div>

	<script type="text/javascript">
		var currentId = 1,
			validateForm;
		$("#addAttr").click(addA);
		$("#cutAttr").click(cutA);
		$("#subBtn").click(sub);
		$("button.close").click(hideAlert);
		$("button.close").click(hideAlert);

		$().ready(function() {
			validateForm = $("form.form-horizontal").validate({
				rules:{
				mainUrl:{
					required:true,					
				},
				dataUrl:{
					required:true
				},
				attName0:"required",
				Xpath0:"required"
				},
				message:{

				},
				debug:true
			});
		});
		//添加元素
		function addA(){
			curName = "attName" + currentId; //属性ID
			curXpathName = "Xpath"+currentId;//XpathID
			var $add = '<div class="form-group"><label for="'+curName+'" class=" col-sm-2 control-label">ATTRIBUTE'+(currentId+1)+' NAME</label><div class="col-sm-2"><input type="text" name="'+curName+'" id="'+curName+'" class="form-control" placeholder="Please input the attribute"></div><label for="'+curXpathName+'" class="col-sm-1 control-label"> XPath'+(currentId+1)+' </label><div class="col-sm-5"><input type="text" name="'+curXpathName+'" id="'+curXpathName+'" class="form-control" placeholder="Please input the XPath"></div></div>';			
			$("#Btn").before($add);
			$("#"+curName).focus();
			currentId ++;
		}

		//删除元素
		function cutA(){
			var $cut = $("#Btn").prev();	//获取最后一个属性元素
			if(currentId > 1)  //至少保留一个属性
			{
				$cut.remove();
				currentId--;
			}

		}

		function hideAlert(){
			$(this).parent().hide('fast');
		}
		
		//提交表单
		function sub(){
			
			if(validateForm.form()) //如果表单符合要求
			{
				var postData = "{";
				var $message = $("input[type='text']");
				$message.each(function(index, el) {
					postData += '"'+$(el).attr('name')+'":"'+$(el).val()+'"';
					if(index != ( $message.length-1)) //如果不是最后一位才能添加逗号
						postData += ",";
				});
				 postData += "}";
				$.ajax({
					url: '/index',
					type: 'POST',
					dataType: 'json',
					data: postData,
					success:function(data){
						console.log(data);
						$("div.alert-success").show('400');
					},
					error:function(data){	
						console.log(data);
						$("div.alert-danger").show('400');
					}
				});
			}
		}
		function getNumber(){
			$.ajax({
				url: '/getNumber', //获取以爬取数量
				type: 'GET',  //随意修改此选项
				dataType: 'json', //返回json数据结构 {'number'：***}
				timeout:500, //设置超时限制 以防网络不好
				success:function(data){
					$('#number').text(data.number);
				},
				error:function(xhr,status,error){
					console.error(xhr);
					console.error(status);
					console.error(data);
				}
			});
		}

		$('#testbtn').click(function(event){
			$($('div.loadingDiv')[0]).css('left','0%');
			setInterval(getNumber,500); // 每0.5s查询一次
		});

		$('#colseBtn').click(function(){
			$($('div.loadingDiv')[0]).css('left','-100%');
		});
	</script>
</body>
</html>